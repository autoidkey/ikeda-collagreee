<!-- user_admin?メッソドがへルパーメッソドのコントローラーにある　 -->
<!-- roleが０だとmodelのuseをみるとemnuでをadminになるようになっている！！　だからroleが０だとtrueで以下が表示される -->
<% if user_admin?(current_user) %>

  <div class="btn-group btn-group-justified" role="group" aria-label="">

    <% if params[:locale] == 'ja' %>
      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/1' , method: :post, data: { confirm: t('themes.switch_divergence') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.divergence') %></button>
        <% end %>
      </div>

      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/2', method: :post, data: { confirm: t('themes.switch_convergence') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.convergence') %></button>
        <% end %>
      </div>

      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/3', method: :post, data: { confirm: t('themes.switch_consensus') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.consensus') %></button>
        <% end %>
      </div>
    <% elsif params[:locale] == 'en' %>
      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/1?locale=en' , method: :post, data: { confirm: t('themes.switch_divergence') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.divergence') %></button>
        <% end %>
      </div>

      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/2?locale=en', method: :post, data: { confirm: t('themes.switch_convergence') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.convergence') %></button>
        <% end %>
      </div>

      <div class="btn-group" role="group">
        <%= link_to '/themes/' + @theme.id.to_s + '/update_phase'+'/3?locale=en', method: :post, data: { confirm: t('themes.switch_consensus') } do %>
          <button type="button" class="btn btn-default"><%= t('themes.consensus') %></button>
        <% end %>
      </div>
    <% end %>
  </div>
  <br />
<% end %>



<!-- roleは役割を表す -->
<ul class="nav nav-pills nav-collagree" role="tablist">
  <li class="active"><a href="#discussion" role="tab" data-toggle="tab" id="discussion-nav-btn"><%= t('themes.debate') %></a></li>
  <li><a href="#infomation" role="tab" data-toggle="tab"><%= t('themes.ranking') %></a></li>
  <% if current_user.admin? || current_user.facilitator? %>
    <li><a href="#tree" role="tab" data-toggle="tab" action="signed_in" id="tree-nav-btn"><%= t('themes.debate_tree') %></a></li>
    <li><%= link_to "議論ツリー編集", thread_classes_all_path(@theme.id) %></li>
  <% else %>
    <% if current_user.id.even? %>
      <li><a href="#tree" role="tab" data-toggle="tab" action="signed_in" id="tree-nav-btn"><%= t('themes.debate_tree') %></a></li>
    <% end %>
  <% end %>
  <% if user_signed_in? %>
    <% if smartphone? %>
      <li><a href="#get-point" role="tab" data-toggle="tab"><%= t('themes.point_acquired') %></a></li>
    <% end %>
  <% end %>
</ul>

<!-- Tab panes -->
<div class="tab-content" id="theme-show">
  <div class="tab-pane active" id="discussion">

    <div class="row">
      <div class="col-md-8">

        <!-- 投稿フォームについて -->
        <div id="main-form">
          <%= render 'top_form' if user_signed_in? %>
        </div>

        <div id="main-form">
          <%= render 'groundrule' %>
        </div>

        <hr />

        <div class="well" id="entry_notice">
          <span><%= t('themes.newpost_ga') %></span><span id="entry_notice_count">0</span><%= t('themes.count_arimasu') %>
        </div>

        <!-- 検索するビュー -->
        <div class="well" id="tl-tool">
          <%= render 'search_form'  %>
        </div>

        <div id="top-loading">
          <%= image_tag 'theme/icon-loading.gif' %>
        </div>

        <!-- それぞれの記事を表示するビュー -->
        <div id="timeline">
          <% @entries.each_with_index do |entry, i| %>
            <%= render 'panel', entry: entry %>
          <% end %>
        </div>

        <div id="icon-loading">
          <%= image_tag 'theme/icon-loading.gif' %>
        </div>

         <div id="next" class="next_link_div"><%= link_to_next_page @entries, t('themes.next_page'), :remote => true, :id => 'next_link', :class=>'next_link_a_tag'  %></div>

      </div>

      <div class="col-md-4">
        <%= render 'theme_info' %>
        <%= render 'point', user: current_user, theme: @theme, point_list: @point_list if user_signed_in? %>
        <%= render 'user_ranking', users: @users, theme: @theme %>
        <%#= render 'activity' if user_signed_in? %>
        <!-- 議題 -->
        <%# if smartphone? %>
          <%#= render 'facilitation_keywords_mobile' %>
        <%# else %>
          <%#= render 'facilitation_keywords' %>
        <%# end %>
        <!-- キーワード -->
        <% if smartphone? %>
          <%= render 'keywords_mobile' %>
        <% else %>
          <%= render 'keywords' %>
        <% end %>
        <%#= render 'other_themes' %>
        <%= render 'users' %>
        <%= render 'tags' if user_signed_in? && !current_user.normal? %>
      </div>
    </div>


  </div>

  <!-- ランキンングについて -->
  <div class="tab-pane" id="infomation">
    <div class="row">
      <div class="col-md-6">
        <%= render 'user_ranking', users: @users, theme: @theme %>
      </div>
      <div class="col-md-6">
        <%= render 'user_ranking_entry', users: @users_entry, theme: @theme %>
      </div>
    </div>
  </div>

  
  <!-- 議論ツリーについて -->
  <% if current_user.id.even? || current_user.admin? %>
    <div class="tab-pane" id="tree">
      <div class="row">
        <div class="col-md-12">
          <%= render 'user_tree' ,action: :"signed_in", theme: @theme , entries: @entries , entryAll: @entry_tree,youyaku: @youyaku ,type: @tree_type ,claster: @themes_claster ,fas: @facilitator,user: @user_id, youyaku_thread: @youyaku_thread, classes: @classes %>
        </div>
      </div>
    </div>
  <% end %>


  <% if user_signed_in? %>
    <% unless smartphone? %>
      <div class="tab-pane" id="point_graph">
        <div class="row">
          <div class="col-md-6" id="user_point_graph">
          </div>
        </div>
      </div>
    <% else %>
      <div class="tab-pane" id="get-point">
        <div class="row">
          <div class="col-md-6">
            <%= render 'point', user: current_user, theme: @theme, point_list: @point_list if user_signed_in? %>
          </div>
        </div>
      </div>
    <% end %>
  <% end %>

</div>

<!--議論ツリーへ移動するボタン-->
<div id="page-top" class="page-top">
  <p><a href="#tree" id="move-page-top" class="move-page-top" role="tab" data-toggle="tab" action="signed_in"><%= t('themes.debate_tree') %></a></p>
</div>


<!-- このjsは議論ツリーでノードから議論に移動するために記述 -->
  <script type = "text/javascript">
//     var id  = <%= raw @nodeId %>
//     if (id!=0){
//       id = id[0].substr(1)
//       id = '#entry-'+id
//       console.log(id)
//        $('html,body').animate({
//           scrollTop: $(id).offset().top}, {
//           duration: 400,
//           easing: "swing",
//           complete: function(){
//             //アニメーション後になにかしたいならここに書く
//           }
//         });
//   }
 </script>

<%= render 'render_c3' %>

<%= javascript_include_tag 'pnotify.custom.min.js', 'data-turbolinks-track' => true %>
<%= stylesheet_link_tag 'mobile.css' if smartphone? %>

<% if current_user.id.even? %>
  <script>
    // 議論ツリー移動ボタンよう
    // グローバル変数
    var syncerTimeout = null ;

    // 一連の処理
    $( function()
    {
      // スクロールイベントの設定
      $( window ).scroll( function()
      {
        // 1秒ごとに処理
        if( syncerTimeout == null )
        {
          // セットタイムアウトを設定
          syncerTimeout = setTimeout( function(){

            // 対象のエレメント
            var element = $( '#page-top' ) ;

            // 現在、表示されているか？
            var visible = element.is( ':visible' ) ;

            // 最上部から現在位置までの距離を取得して、変数[now]に格納
            var now = $( window ).scrollTop() ;

            // 最下部から現在位置までの距離を計算して、変数[under]に格納
            var under = $( 'body' ).height() - ( now + $(window).height() ) ;

            // 最上部から現在位置までの距離(now)が1500以上かつ
            // 最下部から現在位置までの距離(under)が200px以上かつ…
            if( now > 1500 && 200 < under )
            {
              // 非表示状態だったら
              if( !visible )
              {
                // [#page-top]をゆっくりフェードインする
                element.fadeIn( 'slow' ) ;
              }
            }

            // 1500px以下かつ
            // 表示状態だったら
            else if( visible )
            {
              // [#page-top]をゆっくりフェードアウトする
              element.fadeOut( 'slow' ) ;
            }

            // フラグを削除
            syncerTimeout = null ;
          } , 1000 ) ;
        }
      } ) ;

      // クリックイベントを設定する
      $( '#move-page-top' ).click(
          function()
          {
            // スムーズにスクロールする
            $( 'html,body' ).animate( {scrollTop:0} , 'slow' ) ;
            $("#tree-nav-btn").parents('li').addClass("active");
            $("#discussion-nav-btn").parents('li').removeClass("active");
          }
      ) ;
    } ) ;

    $(window).bind("beforeunload", function() {

      var user = <%= raw current_user.id.to_json %>;
      var theme = <%= raw @theme.id.to_json %>;


      $.ajax({
        url: "tree/change_session_year",
        type: "POST",
        data: {user_id : user,
          theme: theme,
          flag: true,
        },
        dataType: "html",
        success: function(data) {
        },
        error: function(data) {
          console.log(data);
        }
      });
    });
  </script>
<% end %>

<script>
    modal.set();

</script>
